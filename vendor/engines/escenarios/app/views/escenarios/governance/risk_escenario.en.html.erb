<% if @escenario.nil? %>
<div class="alert alert-danger">
	<p>Selected scenario not found.</p>
</div>

<div class="btn-group">
  <button type="button" class="btn btn-default" onclick="location.href='../inicio/inicio'">Home</button>
</div>

<% elsif (@escenario.governance_structure.nil?) && (@escenario.decision_map_id.nil?) # Consolidated (only visualization) %>

<style>

span.gen
{
  width:35px;
  height:25px;
  margin-right:5px;
  border:solid 2px #4A8AFA;
  display:inline-block;
}


</style>

<script>

$(function() {
  $( "#dialogRiskScale" ).dialog({
    autoOpen: false,
    resizable: false,
    modal: true,
    buttons: {
      "Accept": function() 
      {
        $( this ).dialog( "close" );
      }
    }
  });
});

</script>

<script>

$(document).on('click', "span#showRiskScale", function () 
{
   $("#dialogRiskScale").dialog("option", "width", 700);
   $("#dialogRiskScale").dialog("option", "height", 540);
   $("#dialogRiskScale").dialog("option", "resizable", false);
   $("#dialogRiskScale").dialog("open");
});



</script>


  <div>
    <ol class="breadcrumb">
      <li><%= link_to "Home", main_app.inicio_inicio_path %></li>
      <li><%= link_to "Risk Assessment Scenarios", governance_risks_path %></li>
      <li class="active">[<%= @empresa.name %>] Risk Assessment: <%= @escenario.name %></li>
    </ol>
  </div>

  <h2>Scenario: <%= @escenario.name %> <span id="showRiskScale" title="Show risk assessment scale">Show risk assessment scale</span></h2>

  <p>Below are presented the assessed risks through partial scenarios consolidation</p>
  </br>

  <!-- Show each risk, with its respective score, if exists and group them by risk category -->
  <% @categories.each do |cat| %>
    <div class="alert alert-info">
      <span style="font-size:18px;">Risk Category: <%= cat.description %></span>
    </div>
    <% myRisks = @risks.select{|r| r.risk_category.id_padre == cat.id} %>
    <% @risks = @risks - myRisks %>
    <% myRisks.each do |risk| %>

    <div style="width:100%;height:40px;margin-top:10px;">
      <% calGen = @cals.select { |cal|  cal.risk == risk  }.first %>
      <% if !calGen.nil? %>
      <div style="float:left;width:3%;">
        <span class="gen" title="Average score of its specific risks">
          &nbsp;&nbsp;<%= calGen.valor %>
        </span>
      </div>
      <% else %>
      <div style="float:left;width:3%;">
        <span class="gen" title="Average score of its specific risks">
        </span>
      </div>
      <% end %>
      
      <div style="float:left;width:93%;margin-left:1%;">
        <span style="padding-top:2px;"><%= risk.descripcion %></span>
      </div>
    </div>

    <!-- Renders also the sons -->
    <% hijos = @hijos.select{|h| h.riesgo_padre_id == risk.id}%>
      <% if hijos.size > 0 %>
      <% @hijos = @hijos - hijos %>
        <% hijos.each do |h| %>
          <!-- Checks if that risk has an score: -->
          <% myCal = @cals.select { |cal|  cal.risk == h  }.first %>
          <% if myCal.nil? %>
          <!-- No score:-->
          <p style="margin-left:3%;color:#333;">
            <span style="width:35px;height:20px;margin-right:5px;border:solid 1px #333;cursor:pointer;display:inline-block;">
            </span><i>- <%= h.descripcion %></i>
          </p>
          <% else %>
          <!-- Score: -->
          <% # To assign the cell color and the importance/tolerance, takes the value from levels
             # Currently hardcoded!!! Must fix it!!!

              cont = 0
              @niveles.each do |nivel|
                cont+= 1
                if nivel.to_i == myCal.valor.to_i
                  break
                end
              end

              color = 'yellow'
              importancia = 'Medium/Tolerable'

                
              if cont == 19 || cont == 25 || cont == 26 || cont == 31 || cont == 32 || cont == 33 
                  # GREEN:  
                 color = 'green'
                 importancia = 'Low/Acceptable'

              elsif cont == 4 || cont == 5 || cont == 6 || cont == 11 || cont == 12 || cont == 18 
                # RED
                color = 'red'
                importancia = 'Highest/Inadmissible'

              elsif cont == 2 || cont == 3 || cont == 9 || cont == 10 || cont == 16 || cont == 17 || cont == 23 || cont == 24 || cont == 30
                 # ORANGE
                 color = 'orange'
                 importancia = 'High/Unacceptable'
              end
          %>
          <p style="margin-left:3%;color:#333;">
            <span style="background-color:<%= color %>;width:35px;height:20px;margin-right:5px;border:solid 1px #333;display:inline-block;color:black;">&nbsp;&nbsp;<%= myCal.valor %>
            </span><i>- <%= h.descripcion %></i><br>
            <span style="font-size:12px;color:#AAA;">
              <i>
                Financial Impact: <%= myCal.cantidad %> (USD), Risk Type: <%= myCal.risk_type %>, 
                Importance/Tolerance: <%= importancia %>, Evidence: <%= myCal.evidence %>
              </i>
            </span>
          </p>
          
          <% end %>
        
        <% end %>
      <% end %>

    <% end # @risks.each do %>

  <% end # @categories.each do %>




  <div id="dialogRiskScale" title="Risk Assessment Scale">
    <div style="width:100%;height:270px;">
    <!-- Space for the graph's legend -->
    <div style="float:left;width:145px;">
      <img src="/assets/y-axis_en.png" style="margin-top:35px;">
    </div>
    <div style="float:left;width:240px;">
      <table style="margin-top:20px;color:black;text-align:center;font-size:13px;">
        <tr style="border: 1px solid white;height:40px;">
          <td class="riskmap" style="background:yellow;"><%= @niveles[0] %></td>
          <td class="riskmap" style="background:orange;"><%= @niveles[1] %></td>
          <td class="riskmap" style="background:orange;"><%= @niveles[2] %></td>
          <td class="riskmap" style="background:red;"><%= @niveles[3] %></td>
          <td class="riskmap" style="background:red;"><%= @niveles[4] %></td>
          <td class="riskmap" style="background:red;"><%= @niveles[5] %></td>
        </tr>
        <tr style="border: 1px solid white;height:40px;">
          <td class="riskmap" style="background:yellow;"><%= @niveles[6] %></td>
          <td class="riskmap" style="background:yellow;"><%= @niveles[7] %></td>
          <td class="riskmap" style="background:orange;"><%= @niveles[8] %></td>
          <td class="riskmap" style="background:orange;"><%= @niveles[9] %></td>
          <td class="riskmap" style="background:red;"><%= @niveles[10] %></td>
          <td class="riskmap" style="background:red;"><%= @niveles[11] %></td>
        </tr>
        <tr style="border: 1px solid white;height:40px;">
          <td class="riskmap" style="background:yellow;"><%= @niveles[12] %></td>
          <td class="riskmap" style="background:yellow;"><%= @niveles[13] %></td>
          <td class="riskmap" style="background:yellow;"><%= @niveles[14] %></td>
          <td class="riskmap" style="background:orange;"><%= @niveles[15] %></td>
          <td class="riskmap" style="background:orange;"><%= @niveles[16] %></td>
          <td class="riskmap" style="background:red;"><%= @niveles[17] %></td>
        </tr>
        <tr style="border: 1px solid white;height:40px;">
          <td class="riskmap" style="background:green;"><%= @niveles[18] %></td>
          <td class="riskmap" style="background:yellow;"><%= @niveles[19] %></td>
          <td class="riskmap" style="background:yellow;"><%= @niveles[20] %></td>
          <td class="riskmap" style="background:yellow;"><%= @niveles[21] %></td>
          <td class="riskmap" style="background:orange;"><%= @niveles[22] %></td>
          <td class="riskmap" style="background:orange;"><%= @niveles[23] %></td>
        </tr>
        <tr style="border: 1px solid white;height:40px;">
          <td class="riskmap" style="background:green;"><%= @niveles[24] %></td>
          <td class="riskmap" style="background:green;"><%= @niveles[25] %></td>
          <td class="riskmap" style="background:yellow;"><%= @niveles[26] %></td>
          <td class="riskmap" style="background:yellow;"><%= @niveles[27] %></td>
          <td class="riskmap" style="background:yellow;"><%= @niveles[28] %></td>
          <td class="riskmap" style="background:orange;"><%= @niveles[29] %></td>
        </tr>
        <tr style="border: 1px solid white;height:40px;">
          <td class="riskmap" style="background:green;"><%= @niveles[30] %></td>
          <td class="riskmap" style="background:green;"><%= @niveles[31] %></td>
          <td class="riskmap" style="background:green;"><%= @niveles[32] %></td>
          <td class="riskmap" style="background:yellow;"><%= @niveles[33] %></td>
          <td class="riskmap" style="background:yellow;"><%= @niveles[34] %></td>
          <td class="riskmap" style="background:yellow;"><%= @niveles[35] %></td>
        </tr>
      </table>
      </div>
      <div style="float:left;width:220px;">
        <img src="/assets/imp_tol_en.png" style="margin:17px 0 10px 55px">
        <img align="left" src="/assets/money.png" style="width:30px;height:30px;margin: 10px 5px 0 70px;"><p style="font-size:11px;width:70%;margin-left:45%;">Financial Impact (aprox) per risk unit (en USD):</p></img>
        <input type="number" style="margin:8px 0 10px 70px;width:150px;" min="0" disabled value="<%= @niveles[36]%>">
      </div>
    
    </div><!-- 100% -->

    <div style="width:100%;">
      <img src="/assets/x-axis_en.png" style="margin:9px 0 0 0;">
    </div>

  </div>


<% else %>

<script>

// DELETE A RISK:
$(document).on('click', "span.delete", function () {
    var idrisk = this.id;
    idrisk = idrisk.replace("delete", "");
    idrisk = idrisk.trim();
    var risk_escenario_id = '<%= @escenario.id %>';
    var html;
    $.post('./getDeleteableRisk', {'id' : idrisk, 'risk_escenario_id': risk_escenario_id}, function(data)
    {
      var riesgo = data[0];
      var puedeBorrar = data[1];
      if (puedeBorrar) 
      {
        // Send and ask normally
        $("#dialog-confirm").data('autorizado', true);
        $("#dialog-confirm").dialog("option", "height", 250);
        html = '<p>Do you really want to delete this risk? </p><span style="color:green;font-weight:bold;font-size:12px;">' 
                + riesgo.descripcion + '</span>';
      } 
      else
      {
        $("#dialog-confirm").data('autorizado', false);
        $("#dialog-confirm").dialog("option", "height", 350);        
        html = '<p>The following risk CAN´T be deleted, because is the only specific risk associated to its father. To be able to delete it, you have to create at least 1 additional specific risk under its father.</p><span style="color:green;font-weight:bold;font-size:12px;">' 
                + riesgo.descripcion + '</span>';
      };

      
      $("#dialog-confirm").html(html);
      $("#dialog-confirm").dialog("option", "width", 500);
      // Pass the risk id, as a dialog's parameter:
      $("#dialog-confirm").data('idrisk', idrisk);
      $("#dialog-confirm").dialog("open");

    });

});

// SCORE A RISK:
$(document).on('click', "span.eval", function () {
    // eval309 -> 309 is the risk code
    var idrisk = this.id;
    idrisk = idrisk.replace("eval", "");
    idrisk = idrisk.trim();

    // Clean the values: risk type and evidence:
    $("#evidence").val("");

    // Send an AJAX request to get the risk information:
    $.post('../governance/get_info_risk', {'id' : idrisk}, function(data)
    {
      $("#txt_risk").val(data[0]);

      // Send an AJAX request to get the score information:
      $.get('./get_info_cal_risk', {'idRisk' : idrisk, 'idEsc' : '<%= @escenario.id %>'}, function(data)
      {
        // Restart the borders
        $(".riskmap").css({'border-color': 'white',
                           'border-width': '1px',
                           'border-style': 'solid'});

         // Restart the input that quantifies the risk:
         $("#qriesgo").val('');

        // Pass the score information to the dialog:
        if (data != null) 
        {
          // Make explicit the quantity:
          $("#riskmap" + data.valor).css({'border-color': '#0E3966',
                           'border-width': '5px',
                           'border-style': 'solid'});
          // Define the evidence:
          if (data.evidence != null) {$("#evidence").val(data.evidence);};
          // Define the risk type:
          if (data.risk_type != null && data.risk_type != 'No definido') 
          {
            $('#riskType > option').removeAttr('selected');
            $('#riskType > option[value='+data.risk_type+']').prop('selected', true);

          };

        };
        
        
        // Show the dialog:
		     $("#errorZone").html("");
         $("#dialog").dialog("option", "width", 700);
         $("#dialog").dialog("option", "height", 640);
         $("#dialog").dialog("option", "resizable", false);
         // Pass the risk id, as a dialog's parameter:
         $("#dialog").data('idrisk', idrisk);
         $("#dialog").dialog("open");
      });

    });

});


// DISCARD NEW RECORD:
$(document).on('click', "img.discard", function() {
  var id = this.id;
  id = id.replace("discard", "").trim(); 
  // Deletes all the div:
  $("#divCreate"+id).remove();
});

// SAVE NEW RECORD:
$(document).on('click', "img.save", function() {
  var idPadre = this.id;
  idPadre = idPadre.replace("save", "").trim(); 
  // Get the description:
  var desc = $("#inputCreate"+idPadre).val().trim();
  var tipoEscenario = '<%= @tipoEscenario %>';
  var idEscenario;
  // According to the scenario's type, decide if the scenario's id need to be sent or not
  if (tipoEscenario == '<%= RISK_ESC_GENERADO %>') 
  {
    // Send the scenario's id
    idEscenario = '<%= @escenario.id %>';
  };

  // Verify the parameters:
  if (desc == '') 
  {
    // ERROR:
    // Remove the borders and background-color:
    $("#divCreate"+idPadre).css({'border-color': 'none',
                              'background-color': 'none',
                              'color': 'none'});

    $("#divCreate"+idPadre).attr("class", "alert alert-danger");
  } 
  else
  {
    // Creates the new goal through AJAX:
    $.post('./add_specific_risk', {'idPadre' : idPadre, 'desc' : desc, 'risk_escenario_id' : idEscenario}, function(data)
    {
      if (data.id != null) 
      {
        // Remove the creation div:
        $("#divCreate"+idPadre).remove();
        // Inserts the record, after its father:
        var html = 
        '<p style="margin-left:3%;color:#333;" id="par'+data.id+'">'+
          '<span id="eval'+data.id+'" style="width:35px;height:20px;margin-right:5px;border:solid 1px #333;cursor:pointer;display:inline-block;" title="Assess risk" class="eval">'+
          '</span>'+
          '<i>- '+data.descripcion+'</i><span class="delete" title="Delete risk" id="delete'+data.id+'">[x]</span>'+
          '<span style="color:green;font-weight:bold;margin-left:5px;">SAVED!</span>'+
        '</p>';

        $(html).insertAfter("#div"+idPadre);
      } 
      else
      {
        // ERROR SAVING...
        // Remove the borders and background-color:
        $("#divCreate"+idPadre).css({'border-color': 'none',
                                  'background-color': 'none',
                                  'color': 'none'});

        $("#divCreate"+idPadre).attr("class", "alert alert-danger");
      };

    });

  };

});


$( document ).ready(function() {

  // Creation of a new specific risk:
  $(".new").click(function(){
    var idRiesgo = this.id.replace("img", "").trim();
    var anterior = document.getElementById("divCreate"+idRiesgo);

    // Only generate it, if wasn't before:
    if (anterior == null) 
    {
      var html = 
      '<div class="alert alert-info" style="margin-left:3%;color:#333;background-color:#eeeeee;border-color:#cacaca;" id="divCreate'+idRiesgo+'">'+
        'Specific risk description: <br>'+
        '<input type="text" style="width:90%;height:30px;border:none;font-size:12px;" id="inputCreate'+idRiesgo+'">'+
        '<img src="/assets/trash.png" align="right" style="margin:0 15px 0 15px;cursor:pointer;" class="discard" id="discard'+idRiesgo+'" title="Discard">'+
        '<img src="/assets/save.png" align="right" style="margin:0 0 0 5px;cursor:pointer;" class="save" id="save'+idRiesgo+'" title="Save">'+
      '</div>';

      // Add it right after the original risk div:
      $(html).insertAfter("#div"+idRiesgo);
    };

  });

  // Selection of a cell from the risk level map:
   $(".riskmap").click(function(){
    
    // Remove the previous borders:
    var id = this.id;
    var value = $("#"+id).text();
    $(".riskmap").css({'border-color': 'white',
     'border-width': '1px',
     'border-style': 'solid'});
    
    // Select the current border
    $("#" + id).css({'border-color': '#0E3966',
     'border-width': '5px',
     'border-style': 'solid'});

    // Updates the financial impact value:
    var unidadImpacto = '<%= @niveles[36]%>';
    unidadImpacto = unidadImpacto * value;    
    $("#qriesgo").val(unidadImpacto);
  });

});

</script>

<script>

$(function () {
  $("#dialog").dialog({
    autoOpen: false,
    modal: true,
    buttons: {
      "Save assessment": function(){
        // Need to get the value from the selected risk level, the cuantification is optional:
        // Go through all cells, searching the one with a different border:
        var valor;
        var qrisk = $("#qriesgo").val();
        // If the quantity is undefined, set it at 0
        if (qrisk == '') 
        {
          qrisk = 0;
        };
        var idEsc = '<%= @escenario.id %>';
        var riesgo = $("#dialog").data('idrisk');
        var color; var fondo; var tipo; var evidencia;
        var selected = "rgb(14, 57, 102)";
        // Colors:
        var green = "rgb(0, 128, 0)";
        var yellow = "rgb(255, 255, 0)";
        var red = "rgb(255, 0, 0)";
        var importancia = 'High/Unacceptable';
        var descRisk = $("#txt_risk").val();


        $('.riskmap').each(function(i, obj) 
        {
          color = $("#" + obj.id).css("border-top-color");
          if ( color == selected) 
          {
            valor = obj.id;
            fondo = $("#" + obj.id).css("background-color");
            if (fondo == green) 
            {
              importancia = 'Low/Acceptable';
            } 
            else if (fondo == red)
            {
              importancia = 'Highest/Inadmissible';
            }
            else if (fondo == yellow)
            {
              importancia = 'Medium/Tolerable';
            };

            valor = valor.replace("riskmap","");
            // "valor" has the risk score: e.g->20
            // "qrisk" has the financial cuantification of each point in the risk level
            // "fondo" has the color from the selected risk level
          };

        });

        tipo = $("#riskType option:selected").val();
        evidencia = $("#evidence").val();
        if (tipo == 'NA') {tipo = 'No definido'};
        if (evidencia == '') {evidencia = 'No definida'};

        

        var html;
    
    if(valor != null)
    {
       // Updates the score through AJAX (additionally the risk's description if necessary):
      $.post('./update_risk_cal', {'valor' : valor, 'cantidad' : qrisk, 'tipo' : tipo, 'evidencia' : evidencia, 'riesgo' : riesgo, 'escenario': idEsc, 'nuevaDesc': descRisk}, function(data)
      {
        // According the status, show the creation or update:
        if (data.id != null) 
        {
          // Succesful creation/update, generates again the new content of the <p> tag, for that risk:
          html = 
          '<span id="eval'+riesgo+'" style="background-color:'+fondo+';width:35px;height:20px;margin-right:5px;border:solid 1px #333;cursor:pointer;display:inline-block;color:black;" title="Assess risk" class="eval">&nbsp;&nbsp;'+valor+
          '</span><i>- '+ descRisk +'</i><span class="delete" title="Delete risk" id="delete'+riesgo+'">[x]</span><span style="color:green;font-weight:bold;margin-left:5px;">UPDATED!</span><br>'+
          '<span style="font-size:12px;color:#AAA;"><i>Financial Impact: '+qrisk+' (USD), Risk Type: '+tipo+', Importance/Tolerance: '+importancia+', Evidence: '+evidencia+'</i></span>';

          // Needs to update also the div of the father (generic):
          $.get('./get_risk_cal', {'riesgo' : riesgo, 'escenario': idEsc}, function(data)
          {

            var htmlGen = '<span class="gen" title="Average score of its specific risks">&nbsp;&nbsp;'+ data.split("|")[1] +'</span>';
            $("#divEvalGen"+data.split("|")[0]).html(htmlGen);
            $("#divEvalGen"+data.split("|")[0]).show();
          }, "text");
          
        } 
        else
        {
        // ERROR
          html = 
          '<span id="eval'+riesgo+'" style="width:35px;height:20px;margin-right:5px;border:solid 1px #333;cursor:pointer;display:inline-block;color:black;" title="Assess risk" class="eval">'+
          '</span><i>- '+ descRisk +'</i><span style="color:red;font-weight:bold;margin-left:5px;">ERROR: Updating!</span>';

        };

        // Replace the content of the <p> tag for that risk:
        $("#par"+riesgo).html(html);

         
       });
       
        $(this).dialog("close");
    }
    else
    {
      $("#errorZone").html('<span style="color:red;">You have to assess the risk before save the modification</span>');
    };

       
      },
      "Cancel": function () {
        $(this).dialog("close");
      }
    },
  });

});

</script>


<script>

$(function() {
  $( "#dialog-confirm" ).dialog({
    autoOpen: false,
    resizable: false,
    modal: true,
    buttons: {
      "Delete": function() 
      {
        // Needs to delete the risk on cascade, deleting also its scores and the scores of its father:
        var riesgo = $("#dialog-confirm").data('idrisk');
        var autorizado = $("#dialog-confirm").data('autorizado');

        if (autorizado) 
        {
          // Delete the risk and its scores:
          $.post('./delete_risk', {'idRisk' : riesgo}, function(data)
          {
            var padre = data.id;
            var idEsc = '<%= @escenario.id %>';
            // Needs to update also the div of the generic father:
            $.get('./get_risk_cal', {'padreId' : padre, 'escenario': idEsc}, function(data)
            {
              // Deletes all its visible information in the window:
              $("#par"+riesgo).remove();
              // Updates its father's visualization:
              var htmlGen = '<span class="gen" title="Average score of its specific risks">&nbsp;&nbsp;'+ data.split("|")[1] +'</span>';
              $("#divEvalGen"+data.split("|")[0]).html(htmlGen);
              if (data.split("|")[1] == 'N') 
              {
                $("#divEvalGen"+data.split("|")[0]).remove(); 
              } 
              else
              {
                $("#divEvalGen"+data.split("|")[0]).show(); 
              };
              
            }, "text");

          });
        };
        
        $( this ).dialog( "close" );
      },
      "Cancel": function() {
        $( this ).dialog( "close" );
      }
    }
  });
});

</script>

<style>

span.gen
{
  width:35px;
  height:25px;
  margin-right:5px;
  border:solid 2px #4A8AFA;
  display:inline-block;
}

span.delete
{
  color: #428bca;
  cursor: pointer;
  margin-left: 5px;
}


</style>



<div>
  <ol class="breadcrumb">
      <li><%= link_to "Home", main_app.inicio_inicio_path %></li>
      <li><%= link_to "Risk Assessment Scenarios", governance_risks_path %></li>
      <li class="active">[<%= @empresa.name %>] Risk Assessment: <%= @escenario.name %></li>
  </ol>
</div>

<h2>Scenario: <%= @escenario.name %></h2>

<% if @cals.size == 0 %>
<p>Below are presented the generic risks provided by DeciTIon, you can assess them with their respective option:</p>
<% else %>
<p>Below are presented the generic assessed risks, you can perform any modification:</p>
<% end %>
</br>

<!-- Show each risk, with its respective score, if exists, and group them by risk category -->
<% @categories.each do |cat| %>
  <div class="alert alert-info">
    <span style="font-size:18px;">Risk Category: <%= cat.description %></span>
  </div>
  <% myRisks = @risks.select{|r| r.risk_category.id_padre == cat.id} %>
  <% @risks = @risks - myRisks %>
  <% myRisks.each do |risk| %>
  <% idDiv = 'div' << risk.id.to_s %>
  <% idImg = 'img' << risk.id.to_s %>
  <% idEvalGen = 'divEvalGen' << risk.id.to_s  %>

  <div style="width:100%;height:40px;margin-top:10px;" id="<%= idDiv %>">
    <div style="float:left;width:3%;">
      <img src="/assets/list_option.png" title="Add a new specific risk under this generic risk" style="margin-right:6px;cursor:pointer;" class="new" id="<%= idImg %>">
    </div>
    <% calGen = @cals.select { |cal|  cal.risk == risk  }.first %>
    <% if !calGen.nil? %>
    <div style="float:left;width:3%;" id="<%= idEvalGen %>">
      <span class="gen" title="Average score of its specific risks">
        &nbsp;&nbsp;<%= calGen.valor %>
      </span>
    </div>
    <% else %>
    <div style="float:left;width:3%;display:none;" id="<%= idEvalGen %>">
      <span class="gen" title="Average score of its specific risks">
      </span>
    </div>
    <% end %>
    
    <div style="float:left;width:93%;margin-left:1%;">
      <span style="padding-top:2px;"><%= risk.descripcion %></span>
    </div>
  </div>

  <!-- Renders also the sons -->
  <% hijos = @hijos.select{|h| h.riesgo_padre_id == risk.id}%>
    <% if hijos.size > 0 %>
    <% @hijos = @hijos - hijos %>
      <% hijos.each do |h| %>
      <% idEval = 'eval' << h.id.to_s %>
      <% idPar = 'par' << h.id.to_s %>
      <% idDel = 'delete' << h.id.to_s %>
        <!-- Checks if this risk has a score: -->
        <% myCal = @cals.select { |cal|  cal.risk == h  }.first %>
        <% if myCal.nil? %>
        <!-- No scores:-->

          <!-- Restrict manual risks in the generated scenarios and viceverse -->
          <% if @tipoEscenario.eql?("MANUAL") %>
            <!-- Restrict the updating of all generated risks -->
            <% if false #!h.risk_escenario_id.nil? # GENERATED, only visualization TO-DO %>
              <p style="margin-left:3%;color:#333;" id="<%= idPar %>">
                <span id="<%= idEval %>"  style="width:35px;height:20px;margin-right:5px;border:solid 1px #333;display:inline-block;" title="Automatically generated risk, is not possible to assess it in this scenario!">
                </span>
                <i>- <%= h.descripcion %></i>
              </p>
            <% else # MANUAL, show it normally %>
              <p style="margin-left:3%;color:#333;" id="<%= idPar %>">
                <span id="<%= idEval %>"  style="width:35px;height:20px;margin-right:5px;border:solid 1px #333;cursor:pointer;display:inline-block;" title="Assess risk" class="eval">
                </span>
                <i>- <%= h.descripcion %></i>
                <span class="delete" title="Delete risk" id="<%= idDel %>">[x]</span>
              </p>
            <% end %>

          <% else %>
            <!-- Restricts the updating of any manual risk -->
            <% if false #h.risk_escenario_id.nil? # MANUAL, only visualization TO-DO %>
              <p style="margin-left:3%;color:#333;" id="<%= idPar %>">
                <span id="<%= idEval %>"  style="width:35px;height:20px;margin-right:5px;border:solid 1px #333;display:inline-block;" title="Manually generated risk, is not possible to assess it in this scenario!">
                </span>
                <i>- <%= h.descripcion %></i>
              </p>
            <% else # GENERATED, show it normally %>
              <p style="margin-left:3%;color:#333;" id="<%= idPar %>">
                <span id="<%= idEval %>"  style="width:35px;height:20px;margin-right:5px;border:solid 1px #333;cursor:pointer;display:inline-block;" title="Assess risk" class="eval">
                </span>
                <i>- <%= h.descripcion %></i>
                <span class="delete" title="Delete risk" id="<%= idDel %>">[x]</span>
              </p>
            <% end %>

          <% end %>

        <% else %>
        <!-- Scored: -->
        <% # To assign the cell color and the importance/tolerance, take the value from levels

            cont = 0
            @niveles.each do |nivel|
              cont+= 1
              if nivel.to_i == myCal.valor.to_i
                break
              end
            end

            color = 'yellow'
            importancia = 'Medium/Tolerable'

              
            if cont == 19 || cont == 25 || cont == 26 || cont == 31 || cont == 32 || cont == 33 
                # GREEN:  
               color = 'green'
               importancia = 'Low/Acceptable'

            elsif cont == 4 || cont == 5 || cont == 6 || cont == 11 || cont == 12 || cont == 18 
              # RED
              color = 'red'
              importancia = 'Highest/Inadmissible'

            elsif cont == 2 || cont == 3 || cont == 9 || cont == 10 || cont == 16 || cont == 17 || cont == 23 || cont == 24 || cont == 30
               # ORANGE
               color = 'orange'
               importancia = 'High/Unacceptable'
            end
        %>

        <!-- Restrict manual risks in the generated scenarios -->
          <% if @tipoEscenario.eql?("MANUAL") %>
            <!-- Restrict the updating of all generaed risks -->
            <% if false #!h.risk_escenario_id.nil? # GENERATED, only visualization TO-DO %>
              <p style="margin-left:3%;color:#333;" id="<%= idPar %>">
                <span style="background-color:<%= color %>;width:35px;height:20px;margin-right:5px;border:solid 1px #333;display:inline-block;color:black;" >&nbsp;&nbsp;<%= myCal.valor %>
                </span><i>- <%= h.descripcion %></i><br>
                <span style="font-size:12px;color:#AAA;">
                  <i>
                    Financial Impact: <%= myCal.cantidad %> (USD), Risk Type: <%= myCal.risk_type %>, 
                    Importance/Tolerance: <%= importancia %>, Evidence: <%= myCal.evidence %>
                  </i>
                </span>
              </p>
            <% else # MANUAL, show it normally %>
              <p style="margin-left:3%;color:#333;" id="<%= idPar %>">
                <span id="<%= idEval %>" style="background-color:<%= color %>;width:35px;height:20px;margin-right:5px;border:solid 1px #333;cursor:pointer;display:inline-block;color:black;" title="Asess risk" class="eval">&nbsp;&nbsp;<%= myCal.valor %>
                </span><i>- <%= h.descripcion %></i><span class="delete" title="Delete risk" id="<%= idDel %>">[x]</span><br>
                <span style="font-size:12px;color:#AAA;">
                  <i>
                    Financial Impact: <%= myCal.cantidad %> (USD), Risk Type: <%= myCal.risk_type %>, 
                    Importance/Tolerance: <%= importancia %>, Evidence: <%= myCal.evidence %>
                  </i>
                </span>
              </p>
            <% end %>

          <% else %>
            <!-- Restrict the updating of all manual risks -->
            <% if false #h.risk_escenario_id.nil? # MANUAL, only visualization TO-DO %>
              <p style="margin-left:3%;color:#333;" id="<%= idPar %>">
                <span style="background-color:<%= color %>;width:35px;height:20px;margin-right:5px;border:solid 1px #333;display:inline-block;color:black;" >&nbsp;&nbsp;<%= myCal.valor %>
                </span><i>- <%= h.descripcion %></i><br>
                <span style="font-size:12px;color:#AAA;">
                  <i>
                    Financial Impact: <%= myCal.cantidad %> (USD), Risk Type: <%= myCal.risk_type %>, 
                    Importance/Tolerance: <%= importancia %>, Evidence: <%= myCal.evidence %>
                  </i>
                </span>
              </p>
            <% else # GENERATED, show it normally %>
              <p style="margin-left:3%;color:#333;" id="<%= idPar %>">
                <span id="<%= idEval %>" style="background-color:<%= color %>;width:35px;height:20px;margin-right:5px;border:solid 1px #333;cursor:pointer;display:inline-block;color:black;" title="Assess risk" class="eval">&nbsp;&nbsp;<%= myCal.valor %>
                </span><i>- <%= h.descripcion %></i><span class="delete" title="Delete risk" id="<%= idDel %>">[x]</span><br>
                <span style="font-size:12px;color:#AAA;">
                  <i>
                    Financial Impact: <%= myCal.cantidad %> (USD), Risk Type: <%= myCal.risk_type %>, 
                    Importance/Tolerance: <%= importancia %>, Evidence: <%= myCal.evidence %>
                  </i>
                </span>
              </p>
            <% end %>

          <% end %>


        
        <% end %>
      
      <% end %>
    <% end %>

  <% end # @risks.each do %>

<% end # @categories.each do %> 


<!-- Dialog to confirm the risk deleting -->
<div id="dialog-confirm" title="Delete risk confirmation">
</div>


<!-- Dialog to assess the risk level -->
<div id="dialog" title="Risk Assessment Level" style="display:none;">
  <!-- Presents the risk detail: -->
  <p style="font-size:12px;">
    RISK TO ASSESS: 
    <input type="text" id="txt_risk" style="margin-left:5px;width:500px;">
  </p> <!-- Description -->
  <hr style="margin:7px 0 7px 0;">
 
  <div style="width:100%;height:270px;">
    <!-- Space for the graph's legend -->
    <div style="float:left;width:145px;">
      <img src="/assets/y-axis_en.png" style="margin-top:35px;">
    </div>
    <div style="float:left;width:240px;">
      <table style="margin-top:20px;color:black;text-align:center;font-size:13px;">
        <tr style="border: 1px solid white;height:40px;">
          <% id = "riskmap" << @niveles[0].to_s %>
          <td class="riskmap" id='<%= id %>' style="background:yellow;cursor:pointer;"><%= @niveles[0] %></td>
          <% id = "riskmap" << @niveles[1].to_s %>
          <td class="riskmap" id='<%= id %>' style="background:orange;cursor:pointer;"><%= @niveles[1] %></td>
          <% id = "riskmap" << @niveles[2].to_s %>
          <td class="riskmap" id='<%= id %>' style="background:orange;cursor:pointer;"><%= @niveles[2] %></td>
          <% id = "riskmap" << @niveles[3].to_s %>
          <td class="riskmap" id='<%= id %>' style="background:red;cursor:pointer;"><%= @niveles[3] %></td>
          <% id = "riskmap" << @niveles[4].to_s %>
          <td class="riskmap" id='<%= id %>' style="background:red;cursor:pointer;"><%= @niveles[4] %></td>
          <% id = "riskmap" << @niveles[5].to_s %>
          <td class="riskmap" id='<%= id %>' style="background:red;cursor:pointer;"><%= @niveles[5] %></td>
        </tr>
        <tr style="border: 1px solid white;height:40px;">
          <% id = "riskmap" << @niveles[6].to_s %>
          <td class="riskmap" id='<%= id %>' style="background:yellow;cursor:pointer;"><%= @niveles[6] %></td>
          <% id = "riskmap" << @niveles[7].to_s %>
          <td class="riskmap" id='<%= id %>' style="background:yellow;cursor:pointer;"><%= @niveles[7] %></td>
          <% id = "riskmap" << @niveles[8].to_s %>
          <td class="riskmap" id='<%= id %>' style="background:orange;cursor:pointer;"><%= @niveles[8] %></td>
          <% id = "riskmap" << @niveles[9].to_s %>
          <td class="riskmap" id='<%= id %>' style="background:orange;cursor:pointer;"><%= @niveles[9] %></td>
          <% id = "riskmap" << @niveles[10].to_s %>
          <td class="riskmap" id='<%= id %>' style="background:red;cursor:pointer;"><%= @niveles[10] %></td>
          <% id = "riskmap" << @niveles[11].to_s %>
          <td class="riskmap" id='<%= id %>' style="background:red;cursor:pointer;"><%= @niveles[11] %></td>
        </tr>
        <tr style="border: 1px solid white;height:40px;">
          <% id = "riskmap" << @niveles[12].to_s %>
          <td class="riskmap" id='<%= id %>' style="background:yellow;cursor:pointer;"><%= @niveles[12] %></td>
          <% id = "riskmap" << @niveles[13].to_s %>
          <td class="riskmap" id='<%= id %>' style="background:yellow;cursor:pointer;"><%= @niveles[13] %></td>
          <% id = "riskmap" << @niveles[14].to_s %>
          <td class="riskmap" id='<%= id %>' style="background:yellow;cursor:pointer;"><%= @niveles[14] %></td>
          <% id = "riskmap" << @niveles[15].to_s %>
          <td class="riskmap" id='<%= id %>' style="background:orange;cursor:pointer;"><%= @niveles[15] %></td>
          <% id = "riskmap" << @niveles[16].to_s %>
          <td class="riskmap" id='<%= id %>' style="background:orange;cursor:pointer;"><%= @niveles[16] %></td>
          <% id = "riskmap" << @niveles[17].to_s %>
          <td class="riskmap" id='<%= id %>' style="background:red;cursor:pointer;"><%= @niveles[17] %></td>
        </tr>
        <tr style="border: 1px solid white;height:40px;">
          <% id = "riskmap" << @niveles[18].to_s %>
          <td class="riskmap" id='<%= id %>' style="background:green;cursor:pointer;"><%= @niveles[18] %></td>
          <% id = "riskmap" << @niveles[19].to_s %>
          <td class="riskmap" id='<%= id %>' style="background:yellow;cursor:pointer;"><%= @niveles[19] %></td>
          <% id = "riskmap" << @niveles[20].to_s %>
          <td class="riskmap" id='<%= id %>' style="background:yellow;cursor:pointer;"><%= @niveles[20] %></td>
          <% id = "riskmap" << @niveles[21].to_s %>
          <td class="riskmap" id='<%= id %>' style="background:yellow;cursor:pointer;"><%= @niveles[21] %></td>
          <% id = "riskmap" << @niveles[22].to_s %>
          <td class="riskmap" id='<%= id %>' style="background:orange;cursor:pointer;"><%= @niveles[22] %></td>
          <% id = "riskmap" << @niveles[23].to_s %>
          <td class="riskmap" id='<%= id %>' style="background:orange;cursor:pointer;"><%= @niveles[23] %></td>
        </tr>
        <tr style="border: 1px solid white;height:40px;">
          <% id = "riskmap" << @niveles[24].to_s %>
          <td class="riskmap" id='<%= id %>' style="background:green;cursor:pointer;"><%= @niveles[24] %></td>
          <% id = "riskmap" << @niveles[25].to_s %>
          <td class="riskmap" id='<%= id %>' style="background:green;cursor:pointer;"><%= @niveles[25] %></td>
          <% id = "riskmap" << @niveles[26].to_s %>
          <td class="riskmap" id='<%= id %>' style="background:yellow;cursor:pointer;"><%= @niveles[26] %></td>
          <% id = "riskmap" << @niveles[27].to_s %>
          <td class="riskmap" id='<%= id %>' style="background:yellow;cursor:pointer;"><%= @niveles[27] %></td>
          <% id = "riskmap" << @niveles[28].to_s %>
          <td class="riskmap" id='<%= id %>' style="background:yellow;cursor:pointer;"><%= @niveles[28] %></td>
          <% id = "riskmap" << @niveles[29].to_s %>
          <td class="riskmap" id='<%= id %>' style="background:orange;cursor:pointer;"><%= @niveles[29] %></td>
        </tr>
        <tr style="border: 1px solid white;height:40px;">
          <% id = "riskmap" << @niveles[30].to_s %>
          <td class="riskmap" id='<%= id %>' style="background:green;cursor:pointer;"><%= @niveles[30] %></td>
          <% id = "riskmap" << @niveles[31].to_s %>
          <td class="riskmap" id='<%= id %>' style="background:green;cursor:pointer;"><%= @niveles[31] %></td>
          <% id = "riskmap" << @niveles[32].to_s %>
          <td class="riskmap" id='<%= id %>' style="background:green;cursor:pointer;"><%= @niveles[32] %></td>
          <% id = "riskmap" << @niveles[33].to_s %>
          <td class="riskmap" id='<%= id %>' style="background:yellow;cursor:pointer;"><%= @niveles[33] %></td>
          <% id = "riskmap" << @niveles[34].to_s %>
          <td class="riskmap" id='<%= id %>' style="background:yellow;cursor:pointer;"><%= @niveles[34] %></td>
          <% id = "riskmap" << @niveles[35].to_s %>
          <td class="riskmap" id='<%= id %>' style="background:yellow;cursor:pointer;"><%= @niveles[35] %></td>
        </tr>
      </table>
      </div>
      <div style="float:left;width:220px;">
        <img src="/assets/imp_tol_en.png" style="margin:17px 0 10px 55px">
        <img align="left" src="/assets/money.png" style="width:30px;height:30px;margin: 10px 5px 0 70px;"><p style="font-size:11px;width:70%;margin-left:45%;">Financial Impact (aprox) per risk unit (en USD):</p></img>
        <input type="number" style="margin:8px 0 10px 70px;width:150px;" min="0" id="qriesgo" disabled value="<%= @niveles[36]%>">
      </div>
	  
    </div><!-- 100% -->

    <div style="width:100%;">
      <img src="/assets/x-axis_en.png" style="margin:9px 0 0 0;">
    </div>

    <hr style="margin:7px 0 7px 0;">

    <div style="width:100%">
	  	<div style="width:40%;float:left;">
	    	<label style="font-weight:normal;font-size:12px;">RISK TYPE:</label>
	    	<select id="riskType" style="font-size:12px;">
	    		<!--<optgroup style="font-size:12px;">-->
	    			<option disabled selected value="NA">Select...</option>
		   			<option value="<%= INHERENTE %>">Inherent</option>
		   			<option value="<%= RESIDUAL %>">Residual</option>
	    		<!--</optgroup>-->
	    	</select>
	    </div>
	    <div style="width:60%;float:left;font-size:12px;">
	    	<label style="font-weight:normal;" style="width:25%;">EVIDENCE:</label>
	    	<input type="text" id="evidence" style="width:75%;" placeholder="Evidence to support the selected risk level">
	    </div>
   </div>

   <div id="errorZone" style="margin-top:10px;"></div>

</div>



<% end %>

